// ============================================================
// OpenRouter モデル一覧取得 (openrouter_list.js)
// ============================================================
// このファイルは、OpenRouter API で利用可能な「無料モデル」の
// 一覧を取得してスプレッドシートに書き出す関数を提供します。
//
// 【用途】
//  - openrouter.js や hybrid_ai.js で使うモデルを選ぶ参考に
//  - どの無料モデルが現在使えるか一覧で確認できる
//
// 【使い方】
//  スクリプトエディタから listFreeModels() を手動実行する。
//  → スプレッドシートに「OpenRouter_Models」シートが作られ、
//    無料モデルの一覧が書き込まれる。
// ============================================================


// ============================================================
// メイン関数: listFreeModels
// ============================================================
// OpenRouter の API からモデル一覧を取得し、
// 無料モデルだけをフィルタリングしてシートに書き出す。
// ============================================================
function listFreeModels() {
  // ----------------------------------------------------------
  // 1. OpenRouter API からモデル一覧を取得
  // ----------------------------------------------------------
  // このエンドポイントはAPIキー不要で誰でもアクセス可能
  const url = "https://openrouter.ai/api/v1/models";
  const response = UrlFetchApp.fetch(url);
  const json = JSON.parse(response.getContentText());

  // ----------------------------------------------------------
  // 2. 無料モデルだけをフィルタリング
  // ----------------------------------------------------------
  // モデルIDに ":free" が含まれるものが無料モデル
  const freeModels = json.data.filter(m => m.id.includes(":free"));

  // ----------------------------------------------------------
  // 3. シートに書き出し
  // ----------------------------------------------------------
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // 既存の「OpenRouter_Models」シートがあれば削除して作り直す
  let sheet = ss.getSheetByName("OpenRouter_Models");
  if (sheet) ss.deleteSheet(sheet);
  sheet = ss.insertSheet("OpenRouter_Models");

  // ヘッダー行を書き込み
  sheet.getRange(1, 1, 1, 3)
    .setValues([["モデルID", "モデル名", "コンテキスト長"]])
    .setFontWeight("bold")             // 太字
    .setBackground("#f3f3f3");          // 背景を薄灰色に

  // ----------------------------------------------------------
  // 4. 各モデルのデータを配列として準備
  // ----------------------------------------------------------
  const rows = freeModels.map(m => [
    m.id,                                // モデルID（APIで指定する文字列）
    m.name,                              // モデル名（人間向けの表示名）
    m.context_length || "N/A"            // コンテキスト長（最大入力トークン数）
  ]);

  // ----------------------------------------------------------
  // 5. データをシートに一括書き込み
  // ----------------------------------------------------------
  if (rows.length > 0) {
    sheet.getRange(2, 1, rows.length, 3).setValues(rows);
  }

  // 列幅を自動調整して見やすくする
  sheet.autoResizeColumns(1, 3);

  // 結果をログに出力（スクリプトエディタの「実行ログ」で確認）
  Logger.log(`${rows.length} 件の無料モデルを書き出しました。`);
}